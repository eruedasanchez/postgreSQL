*-- Modificar registros usando subconsultas - UPDATE con subquery --*

*-- Comenzamos creando la tabla cobranza e insertando los siguientes registros --*

CREATE TABLE cobranza(
	idcliente INTEGER,
	nombre VARCHAR(45),
	apellidopaterno VARCHAR(45),
	apellidomaterno VARCHAR(45),
	fechacobro DATE,
	totaldeuda DECIMAL(7,2),
	cantidadabono DECIMAL(7,2)
);   

INSERT INTO cobranza(idcliente,nombre,apellidopaterno,apellidomaterno,fechacobro,totaldeuda,cantidadabono)
VALUES(1000,'Juan','Vazquez','Perez','2021-08-01',4585.2,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-01',2000.2,0),
 (1002,'Damaris','Gomez','Zaragoza','2021-08-01',2000,0),
 (1003,'Cristina','Lizarraga','Sanchez','2021-08-01',5000,0),
 (1004,'Jesus','Gonzalez','Gamez','2021-08-01',1000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-01',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-01',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-01',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-02',2000,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-03',2000.2,0),
 (1006,'Ana Laura','Barrera','Galvez','2021-08-03',5000.2,0),
 (1007,'Azucena','Sanchez','Lopez','2021-08-03',5000.2,0),
 (1008,'Jose','Serrano','Esparza','2021-08-03',4000.2,0),
 (1009,'Adalberto','Gutierrez','Galvez','2021-08-03',1000.5,0),
 (1000,'Juan','Vazquez','Perez','2021-08-04',4585.2,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-04',2000.2,0),
 (1002,'Damaris','Gomez','Zaragoza','2021-08-04',2000,0),
 (1003,'Cristina','Lizarraga','Sanchez','2021-08-05',5000,0),
 (1004,'Jesus','Gonzalez','Gamez','2021-08-05',1000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-06',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-07',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-08',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-08',2000,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-09',2000.2,0),
 (1006,'Ana Laura','Barrera','Galvez','2021-08-09',5000.2,0),
 (1007,'Azucena','Sanchez','Lopez','2021-08-09',5000.2,0),
 (1008,'Jose','Serrano','Esparza','2021-08-09',4000.2,0),
 (1009,'Adalberto','Gutierrez','Galvez','2021-08-09',1000.5,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-09',2000.2,0),
 (1002,'Damaris','Gomez','Zaragoza','2021-08-09',2000,0),
 (1003,'Cristina','Lizarraga','Sanchez','2021-08-10',5000,0),
 (1004,'Jesus','Gonzalez','Gamez','2021-08-10',1000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-10',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-10',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-10',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-10',2000,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-11',2000.2,0),
 (1006,'Ana Laura','Barrera','Galvez','2021-08-11',5000.2,0),
 (1007,'Azucena','Sanchez','Lopez','2021-08-11',5000.2,0),
 (1008,'Jose','Serrano','Esparza','2021-08-11',4000.2,0),
 (1009,'Adalberto','Gutierrez','Galvez','2021-08-12',1000.5,0),
 (1000,'Juan','Vazquez','Perez','2021-08-12',4585.2,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-12',2000.2,0),
 (1002,'Damaris','Gomez','Zaragoza','2021-08-12',2000,0),
 (1003,'Cristina','Lizarraga','Sanchez','2021-08-14',5000,0),
 (1004,'Jesus','Gonzalez','Gamez','2021-08-14',1000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-14',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-15',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-15',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-08-15',2000,0),
 (1001,'Alberto','Gamez','Galvez','2021-08-16',2000.2,0),
 (1006,'Ana Laura','Barrera','Galvez','2021-08-16',5000.2,0),
 (1007,'Azucena','Sanchez','Lopez','2021-08-16',5000.2,0),
 (1008,'Jose','Serrano','Esparza','2021-08-16',4000.2,0),
 (1009,'Adalberto','Gutierrez','Galvez','2021-08-16',1000.5,0),
 (1003,'Cristina','Lizarraga','Sanchez','2021-09-01',5000,0),
 (1004,'Jesus','Gonzalez','Gamez','2021-09-01',1000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-09-02',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-09-03',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-09-03',2000,0),
 (1005,'Eustaquio','Aranza','Mercado','2021-09-04',2000,0),
 (1001,'Alberto','Gamez','Galvez','2021-09-05',2000.2,0),
 (1006,'Ana Laura','Barrera','Galvez','2021-09-06',5000.2,0),
 (1007,'Azucena','Sanchez','Lopez','2021-09-07',5000.2,0),
 (1008,'Jose','Serrano','Esparza','2021-09-07',4000.2,0),
 (1009,'Adalberto','Gutierrez','Galvez','2021-09-08',1000.5,0);
 
 *-- Por ejemplo, si queremos ver el historial de cobro del cliente con idcliente = 1000
 ejecutamos el comando: --*

SELECT * FROM cobranza WHERE idcliente=1000

*-- Y observamos que las fechas de cobro son 2021-08-01, 2021-08-04 y 2021-08-12 --*

*-- A continuacion, creamos otra tabla llamada historialcobranza que contiene los registros
donde por cada cliente, cuantas veces se comunicaron con el. --*

CREATE TABLE historialcobranza(
	idcliente INTEGER,
	nombre VARCHAR(45),
	apellidopaterno VARCHAR(45),
	apellidomaterno VARCHAR(45),
	cantidadllamadas INTEGER DEFAULT 0
);

*-- En esta tabla, que se encuentra inicialmente vacia, tenemos que almacenar los clientes 
de la tabla cobranza, es decir, los valores de las columnas (idcliente,nombre,apellidopaterno,apellidomaterno) 
y lo hacemos de la siguiente manera: --*

INSERT INTO historialcobranza (idcliente,nombre,apellidopaterno,apellidomaterno)
SELECT DISTINCT idcliente,nombre,apellidopaterno,apellidomaterno FROM cobranza

*-- Ahora, nos resta llenar de valores la columna cantidadllamadas que por defecto, 
la seteamos en 0 y este valor lo vamos a realizar con subconsultas de la siguiente
manera: --*

UPDATE historialcobranza SET cantidadllamadas=subquery.contador 
FROM (SELECT idcliente, COUNT(fechacobro::date) AS contador FROM cobranza GROUP BY 1) AS subquery
WHERE historialcobranza.idcliente=subquery.idcliente;

*-- En este comando, comenzamos actualizando o modificando la tabla historialcobranza en la 
columna 'cantidadllamadas' seleccionando el 'idcliente' y contando la cantidad de fechas de cobro
que tiene dicho cliente en la tabla cobranza y le colocamos el alias contador agrupando (group by)
por 1 = idcliente y a esta subconsulta la llamamos 'subquery' donde coincidan el idcliente de la tabla
historial cobranza con el valor idcliente de la subconsulta 'subquery'. --*

*-- Finalmente, si ejecutamos SELECT * FROM historialcobranza ORDER BY idcliente ASC observamos que
cargaron los valores correctamente en la columna 'cantidadllamadas'. --*

